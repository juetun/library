package freight

import (
	"encoding/json"
	"testing"
)

//邮费计算测试
func TestNewPriceFreight(t *testing.T) {
	type args struct {
		EmsAddress  string `json:"ems_address"`
		SKusFreight string `json:"s_kus_freight"`
	}
	tests := []struct {
		name string
		args args
		want *PriceFreightResult
	}{
		{
			args: args{
				EmsAddress: `{"id":1,"province_id":"510000","city_id":"510100","area_id":"510104","province":"","city":"","area":"","title":"家里","address":"士大夫阿斯蒂芬","area_address":"","contact_user":"李女士","contact_phone":"15108352617","full_address":""}
`,
				SKusFreight: `[{"num":1,"sku":{"sku_id":"441542713672007784","sku_name":"阿斯顿发射点阿斯顿发射点阿斯顿发射点阿斯顿发射点阿斯顿发射点鲜活生鲜螃蟹现货水水鞋子32码对8只 鲜活生鲜螃蟹现货水水","thumbnail":"image|spu|13","thumbnail_url":"","lock_key":"","sku_att_relate_id":0,"image":"","video":"","user_hid":1,"shop_id":1,"sku_status":1,"weight":"1.50","price":"1.00","market_cost":"0.00","price_cost":"0.00","shop_sale_code":"support_code1","provide_channel":0,"provide_sale_code":"asdfadsf0101","sale_num":0,"sale_online_time":"0001-01-01 00:00:00","sale_over_time":null,"volume":"","flag_tester":2,"have_bind_spu":0,"created_at":"0001-01-01 00:00:00","updated_at":"2023-05-12 09:09:08"},"sku_relate":{"id":262,"shop_id":1,"product_id":"440958537740459917","category_id":0,"parent_id":0,"pk":"1","sku_name":"馆长在离石区政府办事时被区长张海文辱骂，推倒致伤，现状态很不稳定，不能正常开馆","sku_id":"441542713672007784","price":"1.00","is_not_attr_name":2,"property_id":1,"spu_status":1,"sale_type":1,"down_payment":"0.00","final_payment":"0.00","freight_template":2,"sale_online_time":"2023-05-07 14:55:48","sale_over_time":null,"final_start_time":"2023-05-07 14:55:48","final_over_time":"2023-05-07 14:55:48","sales_tax_rate":"0.00","sales_tax_rate_value":"0.00","max_limit_num":500,"min_limit_num":1,"is_leaf":1,"sku_status":1,"have_gift":2,"created_at":"2023-05-07 14:55:49","updated_at":"2023-05-13 16:26:51"},"spu":{"product_id":"440958537740459917","title":"国家双减政策的实施,让","user_hid":0,"thumbnail_url":"","brand_id":1,"video":"","video_url":"","shop_id":1,"status":1,"sub_title":"","min_price":"1.00","max_price":"50.00","min_price_cost":"0.00","max_price_cost":"","min_down_payment":"0.00","max_down_payment":"0.00","service_ids":"[1]","keywords":"","sale_num":0,"freight_type":1,"freight_template":2,"total_stock":0,"category_id":2,"sale_type":1,"pull_on_time":"2023-05-13 16:26:51","pull_off_time":null,"sale_online_time":"2023-05-13 16:26:51","sale_over_time":null,"final_start_time":"2000-01-01 00:00:00","final_over_time":"2000-01-01 00:00:00","delivery_time":null,"sale_count_show":0,"relate_type":0,"relate_item_id":"","relate_buy_count":0,"relate_buy_amount":"0.00","settle_type":2,"flag_tester":1},"shop":{"shop_id":1,"name":"测试店铺测试店铺测试店铺测测试店铺测试店铺测试店铺测测试店铺测试店铺测试店铺测测试店铺测试店铺测试店铺测","logo_url":"","bg_image_url":"","bg_image":"image|shop_logo|132","shop_type":2,"shop_entry_type":4,"status":1,"flag_tester":2,"admin_user_hid":1,"need_verify_status":2,"verify_status":"0","created_at":"2023-04-21 17:15:56","updated_at":"2023-04-21 17:16:12"},"ems_address_freight":null,"template_freight":{"freight_model":{"id":2,"shop_id":1,"title":"指定条件包邮(1)","province_id":310000,"city_id":310100,"area_id":310110,"free_freight":2,"pricing_mode":2,"have_use":1,"sale_area":"[{\"a\":[\"320300\",\"340500\",\"371700\",\"140500\",\"330000\",\"340100\",\"150500\",\"310000\",\"320400\",\"110000\",\"152900\",\"330200\",\"370700\",\"370900\",\"140400\",\"150600\",\"320700\",\"341200\",\"150200\",\"150300\",\"330900\",\"140000\",\"152500\",\"330100\",\"370600\",\"110100\",\"120100\",\"131100\",\"130900\",\"152200\",\"341000\",\"140900\",\"320600\",\"310100\",\"360900\",\"371400\",\"140200\",\"320900\",\"340300\",\"330400\",\"361100\",\"370500\",\"370800\",\"130100\",\"130500\",\"370200\",\"331000\",\"141000\",\"320800\",\"321100\",\"371300\",\"130000\",\"131000\",\"340000\",\"360400\",\"341100\",\"341500\",\"341800\",\"370400\",\"150100\",\"330700\",\"340800\",\"360600\",\"150400\",\"330300\",\"340400\",\"330500\",\"340600\",\"360300\",\"130300\",\"150900\",\"321300\",\"341600\",\"360100\",\"130600\",\"130800\",\"320200\",\"140300\",\"150000\",\"360700\",\"371000\",\"320000\",\"331100\",\"360200\",\"a_2\",\"150800\",\"320500\",\"340700\",\"130400\",\"150700\",\"321200\",\"330600\",\"330800\",\"360500\",\"370100\",\"120000\",\"139000\",\"140700\",\"141100\",\"320100\",\"140100\",\"341300\",\"a_1\",\"371200\",\"341700\",\"360800\",\"370300\",\"370000\",\"371600\",\"130700\",\"140800\",\"360000\",\"340200\",\"371100\",\"130200\",\"140600\",\"321000\",\"361000\",\"371500\"],\"fg\":\"12\",\"fp\":\"3.00\",\"eg\":\"2\",\"ep\":\"1.00\"},{\"a\":[\"410700\",\"411400\",\"420900\",\"430200\",\"430300\",\"410000\",\"410100\",\"410500\",\"430400\",\"431200\",\"421300\",\"422800\",\"430000\",\"430800\",\"411100\",\"411300\",\"420700\",\"411600\",\"420200\",\"420800\",\"421100\",\"410400\",\"410800\",\"410900\",\"420600\",\"421200\",\"430700\",\"a_3\",\"411000\",\"411700\",\"420000\",\"420300\",\"430900\",\"433100\",\"410200\",\"411500\",\"419000\",\"430500\",\"430600\",\"431000\",\"420100\",\"429000\",\"430100\",\"421000\",\"431300\",\"410300\",\"410600\",\"420500\",\"411200\",\"431100\"],\"fg\":\"12\",\"fp\":\"3.00\",\"eg\":\"3\",\"ep\":\"1.00\"},{\"a\":[\"510700\",\"511400\",\"510300\",\"510600\",\"511000\",\"511600\",\"511700\",\"513400\",\"510000\",\"510100\",\"510400\",\"510800\",\"510900\",\"511100\",\"511500\",\"511800\",\"511900\",\"513300\",\"510500\",\"511300\",\"512000\",\"513200\"],\"fg\":\"1\",\"fp\":\"5.00\",\"eg\":\"1\",\"ep\":\"3.00\"}]","free_condition":"[{\"a\":[\"510600\",\"510800\",\"511100\",\"511400\",\"511600\",\"510400\",\"510900\",\"511700\",\"513200\",\"511300\",\"511500\",\"511900\",\"512000\",\"511000\",\"511800\",\"513300\",\"510000\",\"510100\",\"510300\",\"510500\",\"510700\",\"513400\",\"a_7\"],\"ft\":2,\"fp\":\"20.00\",\"fn\":2}]","postage_condition":1,"created_at":"2023-03-29 22:34:17","updated_at":"2023-05-12 00:00:00"}},"from_city_id":"0","pk":"g_440958537740459917_441542713672007784"},{"num":1,"sku":{"sku_id":"441542713672269928","sku_name":"尺码","thumbnail":"image|spu|21","thumbnail_url":"","lock_key":"","sku_att_relate_id":0,"image":"","video":"","user_hid":1,"shop_id":1,"sku_status":1,"weight":"1.25","price":"1.00","market_cost":"0.00","price_cost":"0.00","shop_sale_code":"","provide_channel":0,"provide_sale_code":"","sale_num":0,"sale_online_time":"2023-02-20 09:03:22","sale_over_time":null,"volume":"","flag_tester":1,"have_bind_spu":0,"created_at":"2023-02-20 09:03:22","updated_at":"2023-05-12 09:13:12"},"sku_relate":{"id":264,"shop_id":1,"product_id":"440958537740394381","category_id":0,"parent_id":0,"pk":"4","sku_name":"尺码","sku_id":"441542713672269928","price":"1.00","is_not_attr_name":2,"property_id":4,"spu_status":1,"sale_type":1,"down_payment":"0.00","final_payment":"0.00","freight_template":2,"sale_online_time":"2023-05-07 14:59:27","sale_over_time":null,"final_start_time":"2023-05-07 14:59:27","final_over_time":"2023-05-07 14:59:27","sales_tax_rate":"0.00","sales_tax_rate_value":"0.00","max_limit_num":500,"min_limit_num":1,"is_leaf":1,"sku_status":1,"have_gift":2,"created_at":"2023-05-07 14:59:27","updated_at":"2023-05-13 16:27:01"},"spu":{"product_id":"440958537740394381","title":"多项数据创新高带动中国经济回暖","user_hid":0,"thumbnail_url":"","brand_id":1,"video":"","video_url":"","shop_id":1,"status":1,"sub_title":"","min_price":"1.00","max_price":"1.00","min_price_cost":"0.00","max_price_cost":"","min_down_payment":"0.00","max_down_payment":"0.00","service_ids":"[1]","keywords":"123","sale_num":0,"freight_type":1,"freight_template":2,"total_stock":0,"category_id":11,"sale_type":2,"pull_on_time":"2000-01-01 00:00:00","pull_off_time":null,"sale_online_time":"2000-01-01 00:00:00","sale_over_time":null,"final_start_time":"2000-01-01 00:00:00","final_over_time":"2000-01-01 00:00:00","delivery_time":"2023-05-23 00:00:00","sale_count_show":0,"relate_type":0,"relate_item_id":"","relate_buy_count":0,"relate_buy_amount":"0.00","settle_type":2,"flag_tester":1},"shop":{"shop_id":1,"name":"测试店铺测试店铺测试店铺测测试店铺测试店铺测试店铺测测试店铺测试店铺测试店铺测测试店铺测试店铺测试店铺测","logo_url":"","bg_image_url":"","bg_image":"image|shop_logo|132","shop_type":2,"shop_entry_type":4,"status":1,"flag_tester":2,"admin_user_hid":1,"need_verify_status":2,"verify_status":"0","created_at":"2023-04-21 17:15:56","updated_at":"2023-04-21 17:16:12"},"ems_address_freight":null,"template_freight":{"freight_model":{"id":2,"shop_id":1,"title":"指定条件包邮(1)","province_id":310000,"city_id":310100,"area_id":310110,"free_freight":2,"pricing_mode":2,"have_use":1,"sale_area":"[{\"a\":[\"320300\",\"340500\",\"371700\",\"140500\",\"330000\",\"340100\",\"150500\",\"310000\",\"320400\",\"110000\",\"152900\",\"330200\",\"370700\",\"370900\",\"140400\",\"150600\",\"320700\",\"341200\",\"150200\",\"150300\",\"330900\",\"140000\",\"152500\",\"330100\",\"370600\",\"110100\",\"120100\",\"131100\",\"130900\",\"152200\",\"341000\",\"140900\",\"320600\",\"310100\",\"360900\",\"371400\",\"140200\",\"320900\",\"340300\",\"330400\",\"361100\",\"370500\",\"370800\",\"130100\",\"130500\",\"370200\",\"331000\",\"141000\",\"320800\",\"321100\",\"371300\",\"130000\",\"131000\",\"340000\",\"360400\",\"341100\",\"341500\",\"341800\",\"370400\",\"150100\",\"330700\",\"340800\",\"360600\",\"150400\",\"330300\",\"340400\",\"330500\",\"340600\",\"360300\",\"130300\",\"150900\",\"321300\",\"341600\",\"360100\",\"130600\",\"130800\",\"320200\",\"140300\",\"150000\",\"360700\",\"371000\",\"320000\",\"331100\",\"360200\",\"a_2\",\"150800\",\"320500\",\"340700\",\"130400\",\"150700\",\"321200\",\"330600\",\"330800\",\"360500\",\"370100\",\"120000\",\"139000\",\"140700\",\"141100\",\"320100\",\"140100\",\"341300\",\"a_1\",\"371200\",\"341700\",\"360800\",\"370300\",\"370000\",\"371600\",\"130700\",\"140800\",\"360000\",\"340200\",\"371100\",\"130200\",\"140600\",\"321000\",\"361000\",\"371500\"],\"fg\":\"12\",\"fp\":\"3.00\",\"eg\":\"2\",\"ep\":\"1.00\"},{\"a\":[\"410700\",\"411400\",\"420900\",\"430200\",\"430300\",\"410000\",\"410100\",\"410500\",\"430400\",\"431200\",\"421300\",\"422800\",\"430000\",\"430800\",\"411100\",\"411300\",\"420700\",\"411600\",\"420200\",\"420800\",\"421100\",\"410400\",\"410800\",\"410900\",\"420600\",\"421200\",\"430700\",\"a_3\",\"411000\",\"411700\",\"420000\",\"420300\",\"430900\",\"433100\",\"410200\",\"411500\",\"419000\",\"430500\",\"430600\",\"431000\",\"420100\",\"429000\",\"430100\",\"421000\",\"431300\",\"410300\",\"410600\",\"420500\",\"411200\",\"431100\"],\"fg\":\"12\",\"fp\":\"3.00\",\"eg\":\"3\",\"ep\":\"1.00\"},{\"a\":[\"510700\",\"511400\",\"510300\",\"510600\",\"511000\",\"511600\",\"511700\",\"513400\",\"510000\",\"510100\",\"510400\",\"510800\",\"510900\",\"511100\",\"511500\",\"511800\",\"511900\",\"513300\",\"510500\",\"511300\",\"512000\",\"513200\"],\"fg\":\"1\",\"fp\":\"5.00\",\"eg\":\"1\",\"ep\":\"3.00\"}]","free_condition":"[{\"a\":[\"510600\",\"510800\",\"511100\",\"511400\",\"511600\",\"510400\",\"510900\",\"511700\",\"513200\",\"511300\",\"511500\",\"511900\",\"512000\",\"511000\",\"511800\",\"513300\",\"510000\",\"510100\",\"510300\",\"510500\",\"510700\",\"513400\",\"a_7\"],\"ft\":2,\"fp\":\"20.00\",\"fn\":2}]","postage_condition":1,"created_at":"2023-03-29 22:34:17","updated_at":"2023-05-12 00:00:00"}},"from_city_id":"0","pk":"g_440958537740394381_441542713672269928"},{"num":1,"sku":{"sku_id":"441543074433466472","sku_name":"32码","thumbnail":"image|spu|36","thumbnail_url":"","lock_key":"","sku_att_relate_id":0,"image":"","video":"","user_hid":1,"shop_id":1,"sku_status":1,"weight":"0.00","price":"52.00","market_cost":"0.00","price_cost":"30.00","shop_sale_code":"122","provide_channel":0,"provide_sale_code":"333","sale_num":0,"sale_online_time":"2023-02-20 09:10:47","sale_over_time":null,"volume":"","flag_tester":1,"have_bind_spu":0,"created_at":"2023-02-20 09:10:47","updated_at":"2023-04-05 10:04:10"},"sku_relate":{"id":273,"shop_id":1,"product_id":"440958537740263309","category_id":0,"parent_id":269,"pk":"2_4","sku_name":"32码","sku_id":"441543074433466472","price":"52.00","is_not_attr_name":2,"property_id":4,"spu_status":1,"sale_type":1,"down_payment":"0.00","final_payment":"0.00","freight_template":2,"sale_online_time":"2023-05-08 17:30:56","sale_over_time":null,"final_start_time":"2023-05-08 17:30:56","final_over_time":"2023-05-08 17:30:56","sales_tax_rate":"0.00","sales_tax_rate_value":"0.00","max_limit_num":500,"min_limit_num":1,"is_leaf":1,"sku_status":1,"have_gift":2,"created_at":"2023-05-08 17:30:56","updated_at":"2023-05-13 16:27:24"},"spu":{"product_id":"440958537740263309","title":"比亚迪回应长沙工厂“排队辞职”","user_hid":0,"thumbnail_url":"","brand_id":1,"video":"","video_url":"","shop_id":1,"status":1,"sub_title":"","min_price":"1.00","max_price":"52.00","min_price_cost":"0.00","max_price_cost":"","min_down_payment":"0.00","max_down_payment":"0.00","service_ids":"[1]","keywords":"","sale_num":0,"freight_type":1,"freight_template":2,"total_stock":0,"category_id":2,"sale_type":1,"pull_on_time":"2023-05-13 16:27:24","pull_off_time":null,"sale_online_time":"2023-05-13 16:27:24","sale_over_time":null,"final_start_time":"2000-01-01 00:00:00","final_over_time":"2000-01-01 00:00:00","delivery_time":null,"sale_count_show":0,"relate_type":0,"relate_item_id":"","relate_buy_count":0,"relate_buy_amount":"0.00","settle_type":2,"flag_tester":1},"shop":{"shop_id":1,"name":"测试店铺测试店铺测试店铺测测试店铺测试店铺测试店铺测测试店铺测试店铺测试店铺测测试店铺测试店铺测试店铺测","logo_url":"","bg_image_url":"","bg_image":"image|shop_logo|132","shop_type":2,"shop_entry_type":4,"status":1,"flag_tester":2,"admin_user_hid":1,"need_verify_status":2,"verify_status":"0","created_at":"2023-04-21 17:15:56","updated_at":"2023-04-21 17:16:12"},"ems_address_freight":null,"template_freight":{"freight_model":{"id":2,"shop_id":1,"title":"指定条件包邮(1)","province_id":310000,"city_id":310100,"area_id":310110,"free_freight":2,"pricing_mode":2,"have_use":1,"sale_area":"[{\"a\":[\"320300\",\"340500\",\"371700\",\"140500\",\"330000\",\"340100\",\"150500\",\"310000\",\"320400\",\"110000\",\"152900\",\"330200\",\"370700\",\"370900\",\"140400\",\"150600\",\"320700\",\"341200\",\"150200\",\"150300\",\"330900\",\"140000\",\"152500\",\"330100\",\"370600\",\"110100\",\"120100\",\"131100\",\"130900\",\"152200\",\"341000\",\"140900\",\"320600\",\"310100\",\"360900\",\"371400\",\"140200\",\"320900\",\"340300\",\"330400\",\"361100\",\"370500\",\"370800\",\"130100\",\"130500\",\"370200\",\"331000\",\"141000\",\"320800\",\"321100\",\"371300\",\"130000\",\"131000\",\"340000\",\"360400\",\"341100\",\"341500\",\"341800\",\"370400\",\"150100\",\"330700\",\"340800\",\"360600\",\"150400\",\"330300\",\"340400\",\"330500\",\"340600\",\"360300\",\"130300\",\"150900\",\"321300\",\"341600\",\"360100\",\"130600\",\"130800\",\"320200\",\"140300\",\"150000\",\"360700\",\"371000\",\"320000\",\"331100\",\"360200\",\"a_2\",\"150800\",\"320500\",\"340700\",\"130400\",\"150700\",\"321200\",\"330600\",\"330800\",\"360500\",\"370100\",\"120000\",\"139000\",\"140700\",\"141100\",\"320100\",\"140100\",\"341300\",\"a_1\",\"371200\",\"341700\",\"360800\",\"370300\",\"370000\",\"371600\",\"130700\",\"140800\",\"360000\",\"340200\",\"371100\",\"130200\",\"140600\",\"321000\",\"361000\",\"371500\"],\"fg\":\"12\",\"fp\":\"3.00\",\"eg\":\"2\",\"ep\":\"1.00\"},{\"a\":[\"410700\",\"411400\",\"420900\",\"430200\",\"430300\",\"410000\",\"410100\",\"410500\",\"430400\",\"431200\",\"421300\",\"422800\",\"430000\",\"430800\",\"411100\",\"411300\",\"420700\",\"411600\",\"420200\",\"420800\",\"421100\",\"410400\",\"410800\",\"410900\",\"420600\",\"421200\",\"430700\",\"a_3\",\"411000\",\"411700\",\"420000\",\"420300\",\"430900\",\"433100\",\"410200\",\"411500\",\"419000\",\"430500\",\"430600\",\"431000\",\"420100\",\"429000\",\"430100\",\"421000\",\"431300\",\"410300\",\"410600\",\"420500\",\"411200\",\"431100\"],\"fg\":\"12\",\"fp\":\"3.00\",\"eg\":\"3\",\"ep\":\"1.00\"},{\"a\":[\"510700\",\"511400\",\"510300\",\"510600\",\"511000\",\"511600\",\"511700\",\"513400\",\"510000\",\"510100\",\"510400\",\"510800\",\"510900\",\"511100\",\"511500\",\"511800\",\"511900\",\"513300\",\"510500\",\"511300\",\"512000\",\"513200\"],\"fg\":\"1\",\"fp\":\"5.00\",\"eg\":\"1\",\"ep\":\"3.00\"}]","free_condition":"[{\"a\":[\"510600\",\"510800\",\"511100\",\"511400\",\"511600\",\"510400\",\"510900\",\"511700\",\"513200\",\"511300\",\"511500\",\"511900\",\"512000\",\"511000\",\"511800\",\"513300\",\"510000\",\"510100\",\"510300\",\"510500\",\"510700\",\"513400\",\"a_7\"],\"ft\":2,\"fp\":\"20.00\",\"fn\":2}]","postage_condition":1,"created_at":"2023-03-29 22:34:17","updated_at":"2023-05-12 00:00:00"}},"from_city_id":"0","pk":"g_440958537740263309_441543074433466472"}]
`,
			},
		},
	}
	var err error
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			var (
				resEmsAddress ResultGetByAddressIdsItem
				sKusFreight   []*SkuFreightSingle
			)
			if err = json.Unmarshal([]byte(tt.args.EmsAddress), &resEmsAddress); err != nil {
				t.Errorf("UnmarshalEmsAddress() = %v", err.Error())
				return
			}
			if err = json.Unmarshal([]byte(tt.args.SKusFreight), &sKusFreight); err != nil {
				t.Errorf("Unmarshal() = %v", err.Error())
				return
			}
			//邮费计算逻辑
			if tt.want, err = NewPriceFreight(
				//freight.OptionFreightContext(r.Context),
				OptionFreightEmsAddress(&resEmsAddress),
			).
				AppendNeedCalSKus(sKusFreight...).
				Calculate(); err != nil {
				t.Errorf("NewPriceFreight() = %v", err.Error())
			}
			var bt []byte
			if bt,err=json.Marshal(tt.want);err!=nil{
				t.Errorf("Marshal() = %v", err.Error())
				return
			}
			t.Logf("%v", string(bt))
		})
	}
}
